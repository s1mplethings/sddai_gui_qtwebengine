(()=>{const c=document.getElementById('c');const x=c.getContext('2d',{alpha:false});const d=Math.max(1,Math.min(2,window.devicePixelRatio||1));const ui={search:document.getElementById('search'),results:document.getElementById('results'),btnBack:document.getElementById('btnBack'),btnForward:document.getElementById('btnForward'),btnUp:document.getElementById('btnUp'),btnFit:document.getElementById('btnFit'),btnPause:document.getElementById('btnPause'),btnReheat:document.getElementById('btnReheat'),panel:document.getElementById('panel'),pTitle:document.getElementById('pTitle'),pSub:document.getElementById('pSub'),pBC:document.getElementById('pBC'),pKids:document.getElementById('pKids'),pMeta:document.getElementById('pMeta'),btnOpen:document.getElementById('btnOpen'),btnPin:document.getElementById('btnPin'),btnClose:document.getElementById('btnClose'),toast:document.getElementById('toast')};function R(){const r=c.getBoundingClientRect();c.width=Math.floor(r.width*d);c.height=Math.floor(r.height*d)}new ResizeObserver(R).observe(c);R();const v={x:0,y:0,k:1};function SW(sx,sy){return{x:(sx*d-v.x)/v.k,y:(sy*d-v.y)/v.k}}let nodes=[],links=[],by=new Map(),adj=new Map(),out=new Map(),inn=new Map(),deg=new Map();let run=true,E=1;let dragC=false,dragN=null,dragS={x:0,y:0},viewS={x:0,y:0},last={x:0,y:0},moved=false,hover=null,sel=null,lastD={t:0,id:null};const nav={stack:[],idx:-1};function navBtns(){ui.btnBack.disabled=nav.idx<=0;ui.btnForward.disabled=nav.idx>=nav.stack.length-1}function pushH(id){if(!id)return;if(nav.idx>=0&&nav.stack[nav.idx]?.id===id)return;if(nav.idx<nav.stack.length-1)nav.stack.splice(nav.idx+1);nav.stack.push({id,vx:v.x,vy:v.y,vk:v.k});nav.idx=nav.stack.length-1;navBtns()}function back(){if(nav.idx<=0)return;nav.idx--;const s=nav.stack[nav.idx];v.x=s.vx;v.y=s.vy;v.k=s.vk;focus(s.id,{push:false,anim:false});navBtns()}function forward(){if(nav.idx>=nav.stack.length-1)return;nav.idx++;const s=nav.stack[nav.idx];v.x=s.vx;v.y=s.vy;v.k=s.vk;focus(s.id,{push:false,anim:false});navBtns()}function T(msg){ui.toast.textContent=msg;ui.toast.classList.remove('hidden');clearTimeout(T._t);T._t=setTimeout(()=>ui.toast.classList.add('hidden'),1400)}function ep(z){if(z==null)return'';if(typeof z==='string'||typeof z==='number')return String(z);if(typeof z==='object'){if(z.id!=null)return String(z.id);if(z.key!=null)return String(z.key);if(z.name!=null)return String(z.name);if(z.path!=null)return String(z.path);if(z.label!=null)return String(z.label)}return String(z)}function normPath(p){return String(p||'').replace(/\\/g,'/')}function isDir(p){p=normPath(p);if(!p)return false;if(p.endsWith('/'))return true;const last=p.split('/').pop()||'';if(!last.includes('.')&&!/^(readme|license)$/i.test(last))return true;return false}function dirOf(p){p=normPath(p);if(!p)return'';if(p.endsWith('/'))p=p.slice(0,-1);const i=p.lastIndexOf('/');if(i<=0)return'';return p.slice(0,i+1)}function base(p){p=normPath(p);if(!p)return'';if(p.endsWith('/'))p=p.slice(0,-1);return p.split('/').pop()||p}function H01(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)>>>0}return(h>>>0)/4294967296}function ring(t){if(t==='P0')return 0;if(t==='P1')return 140;if(t==='P2')return 280;return 420}
function normalize(g){const ns=(g.nodes||[]).map((n,i)=>({id:String(n.id??n.key??i),label:String(n.label??n.name??n.title??n.path??n.id??i),path:String(n.path??n.file??''),group:String(n.group??n.type??''),meta:n.meta??n,importance:(typeof n.importance==='number')?n.importance:null,tier:n.tier??null,x:(typeof n.x==='number')?n.x:NaN,y:(typeof n.y==='number')?n.y:NaN,vx:0,vy:0,fx:null,fy:null,r:(typeof n.r==='number')?n.r:4}));const ls=(g.links||g.edges||[]).map(e=>({source:ep(e.source??e.from),target:ep(e.target??e.to),w:Number(e.w??e.weight??1),type:e.type??''})).filter(e=>e.source&&e.target);const ids=new Set(ns.map(n=>n.id));function ensure(id){if(ids.has(id))return;ns.push({id,label:id,path:'',group:'',meta:{},importance:null,tier:null,x:NaN,y:NaN,vx:0,vy:0,fx:null,fy:null,r:4});ids.add(id)}for(const e of ls){ensure(e.source);ensure(e.target)}return{nodes:ns,links:ls}}
function enrichDirs(){const CAP=2500;const did=p=>`dir:${p}`;const exists=new Set(nodes.map(n=>n.id));let cnt=0;const contains=new Set();function add(a,b){if(!a||!b)return;const k=a+'->'+b;if(contains.has(k))return;contains.add(k);links.push({source:a,target:b,w:1,type:'contains'})}function ensureDir(p){p=normPath(p);if(!p)return null;if(!p.endsWith('/'))p+='/';const id=did(p);if(exists.has(id))return by.get(id)||null;if(cnt>=CAP)return null;const n={id,label:base(p)||p,path:p,group:'dir',meta:{type:'dir',path:p},importance:null,tier:'P2',x:NaN,y:NaN,vx:0,vy:0,fx:null,fy:null,r:5};nodes.push(n);exists.add(id);by.set(id,n);cnt++;return n}
 for(const n of nodes){const p=normPath(n.path);if(!p)continue;const parent=dirOf(p);const pn=ensureDir(parent);if(isDir(p)){const self=ensureDir(p.endsWith('/')?p:p+'/');if(pn&&self)add(pn.id,self.id)}else{if(pn)add(pn.id,n.id)}let cur=parent;while(cur){const up=dirOf(cur);if(!up)break;const upN=ensureDir(up);const curN=ensureDir(cur);if(upN&&curN)add(upN.id,curN.id);cur=up}}
}
function buildAdj(){by=new Map(nodes.map(n=>[n.id,n]));deg=new Map(nodes.map(n=>[n.id,0]));adj=new Map(nodes.map(n=>[n.id,new Set()]));out=new Map(nodes.map(n=>[n.id,new Set()]));inn=new Map(nodes.map(n=>[n.id,new Set()]));for(const e of links){const s=e.source,t=e.target;if(!by.has(s)||!by.has(t))continue;deg.set(s,(deg.get(s)||0)+1);deg.set(t,(deg.get(t)||0)+1);adj.get(s).add(t);adj.get(t).add(s);out.get(s).add(t);inn.get(t).add(s)}}
function tiers(){const ds=nodes.map(n=>deg.get(n.id)||0).sort((a,b)=>a-b);const p95=ds[Math.floor(ds.length*.95)]||0;const p80=ds[Math.floor(ds.length*.80)]||0;for(const n of nodes){const d0=deg.get(n.id)||0;const l=(n.label||'').toLowerCase();const p=(n.path||'').toLowerCase();const pinned=l.includes('overview')||p.includes('00_overview')||l.includes('runbook')||p.includes('runbook')||p.endsWith('readme.md')||l==='readme';if(typeof n.importance!=='number')n.importance=d0+(pinned?12:0)+(n.group==='dir'?1:0);if(!n.tier){if(pinned)n.tier='P0';else if(d0>=p95)n.tier='P1';else if(d0>=p80)n.tier='P2';else n.tier='P3'}const baseR=(n.group==='dir')?5:4;if(n.tier==='P0')n.r=Math.max(n.r,baseR+3);else if(n.tier==='P1')n.r=Math.max(n.r,baseR+2);else if(n.tier==='P2')n.r=Math.max(n.r,baseR+1.2);else n.r=Math.max(n.r,baseR)}}
function initPos(){for(const n of nodes){const a=H01(n.id)*Math.PI*2;const rr=ring(n.tier);const j=(H01(n.id+':j')-.5)*35;const r=Math.max(0,rr+j);if(!Number.isFinite(n.x)||!Number.isFinite(n.y)){n.x=Math.cos(a)*r;n.y=Math.sin(a)*r}n.vx=0;n.vy=0;n.fx=null;n.fy=null}let hub=nodes[0]||null;for(const n of nodes)if((n.importance||0)>(hub?.importance||0))hub=n;if(hub){hub.x=0;hub.y=0;sel=hub.id;pushH(hub.id)}}
function setGraph(g){const norm=normalize(g);nodes=norm.nodes;links=norm.links;by=new Map(nodes.map(n=>[n.id,n]));enrichDirs();buildAdj();tiers();initPos();fit();E=1;T(`Loaded: ${nodes.length} nodes / ${links.length} links`);if(sel)focus(sel,{push:false,anim:false})}
const P={linkDist:55,linkK:.010,repulsion:1700,repMax:8,centerK:.0015,ringK:.010,damp:.86,collide:6.5,step:1};
function grid(size){const g=new Map();for(let i=0;i<nodes.length;i++){const n=nodes[i];const cx=Math.floor(n.x/size),cy=Math.floor(n.y/size);const k=cx+','+cy;let a=g.get(k);if(!a)g.set(k,a=[]);a.push(i)}return g}
function forces(){if(!run)return;const size=120,g=grid(size);for(let i=0;i<nodes.length;i++){const a=nodes[i];if(a.fx!=null){a.x=a.fx;a.vx=0}if(a.fy!=null){a.y=a.fy;a.vy=0}const cx=Math.floor(a.x/size),cy=Math.floor(a.y/size);for(let ox=-1;ox<=1;ox++)for(let oy=-1;oy<=1;oy++){const arr=g.get((cx+ox)+','+(cy+oy));if(!arr)continue;for(const j of arr){if(j<=i)continue;const b=nodes[j];let dx=a.x-b.x,dy=a.y-b.y;let d2=dx*dx+dy*dy+.01;let dist=Math.sqrt(d2);const minD=P.collide+a.r+b.r;if(dist<minD){const push=(minD-dist)*.05;const nx=dx/dist,ny=dy/dist;a.vx+=nx*push;a.vy+=ny*push;b.vx-=nx*push;b.vy-=ny*push}
const f=Math.min(P.repMax,P.repulsion/d2);const nx=dx/dist,ny=dy/dist;a.vx+=nx*f;a.vy+=ny*f;b.vx-=nx*f;b.vy-=ny*f}}}
for(const e of links){const a=by.get(e.source),b=by.get(e.target);if(!a||!b)continue;let dx=b.x-a.x,dy=b.y-a.y;let dist=Math.sqrt(dx*dx+dy*dy)+1e-6;const desired=(e.type==='contains')?60:P.linkDist;const k=P.linkK*(e.w||1);const f=(dist-desired)*k;const nx=dx/dist,ny=dy/dist;a.vx+=nx*f;a.vy+=ny*f;b.vx-=nx*f;b.vy-=ny*f}
for(const n of nodes){const tr=ring(n.tier);if(tr>0){const dist=Math.sqrt(n.x*n.x+n.y*n.y)+1e-6;const f=(dist-tr)*P.ringK;const nx=n.x/dist,ny=n.y/dist;n.vx+=-nx*f;n.vy+=-ny*f}
 n.vx+=(-n.x)*P.centerK;n.vy+=(-n.y)*P.centerK;n.vx*=P.damp;n.vy*=P.damp;n.x+=n.vx*P.step*(.25+E);n.y+=n.vy*P.step*(.25+E)}
E*=.985;if(E<.02)E=.02}
function pick(sx,sy){const p=SW(sx,sy);const r=12/v.k;let best=null,bd=1e18;for(const n of nodes){const dx=n.x-p.x,dy=n.y-p.y;const d2=dx*dx+dy*dy;const rr=n.r+r;if(d2<rr*rr&&d2<bd){best=n;bd=d2}}return best}
function fit(pad=80){if(!nodes.length)return;let minx=1e18,miny=1e18,maxx=-1e18,maxy=-1e18;for(const n of nodes){minx=Math.min(minx,n.x);miny=Math.min(miny,n.y);maxx=Math.max(maxx,n.x);maxy=Math.max(maxy,n.y)}const w=c.width,h=c.height;const gw=Math.max(1,maxx-minx),gh=Math.max(1,maxy-miny);const k=Math.min((w-pad*d)/gw,(h-pad*d)/gh);v.k=Math.max(.22*d,Math.min(2.6*d,k));const cx=(minx+maxx)*.5,cy=(miny+maxy)*.5;v.x=w*.5-cx*v.k;v.y=h*.5-cy*v.k}
function focus(id,{push=true,anim=true}={}){const n=by.get(String(id));if(!n)return;sel=n.id;if(push)pushH(n.id);E=1;panel(n);if(!anim)return;const w=c.width,h=c.height;const tx=w*.5-n.x*v.k,ty=h*.5-n.y*v.k;const steps=14,sx=v.x,sy=v.y;let t=0;(function A(){t++;const a=t/steps;const e=a<1?(1-Math.pow(1-a,3)):1;v.x=sx+(tx-sx)*e;v.y=sy+(ty-sy)*e;if(t<steps)requestAnimationFrame(A)})()}
function item(n,sub){const el=document.createElement('div');el.className='panel-item';const t=document.createElement('div');t.className='panel-item-title';t.textContent=n.label||n.id;const s=document.createElement('div');s.className='panel-item-sub';s.textContent=sub||n.path||n.group||n.id;el.appendChild(t);el.appendChild(s);el.addEventListener('click',()=>focus(n.id,{push:true,anim:true}));return el}
function bc(n){ui.pBC.innerHTML='';const p=normPath(n.path);if(!p)return;const baseP=isDir(p)?(p.endsWith('/')?p:p+'/'):dirOf(p);if(!baseP)return;const root=document.createElement('div');root.className='bc-item';root.textContent='/';root.addEventListener('click',()=>{fit();T('Fit')});ui.pBC.appendChild(root);const parts=baseP.split('/').filter(Boolean);let cur='';for(const part of parts){cur+=part+'/';const id=`dir:${cur}`;const dn=by.get(id);const el=document.createElement('div');el.className='bc-item';el.textContent=part;el.addEventListener('click',()=>{if(dn)focus(dn.id,{push:true,anim:true});else T('No dir node')});ui.pBC.appendChild(el)}}
function neigh(n){const res=[];const o=out.get(n.id);if(o&&o.size)for(const id of o){const m=by.get(id);if(m)res.push(m)}if(!res.length){const a=adj.get(n.id);if(a&&a.size)for(const id of a){const m=by.get(id);if(m)res.push(m)}}if(!res.length&&isDir(n.path)){const p0=normPath(n.path).replace(/\/+$/,'')+'/';for(const m of nodes){const pp=normPath(m.path);if(!pp||m.id===n.id)continue;if(!pp.startsWith(p0))continue;const rest=pp.slice(p0.length);if(rest&&rest.indexOf('/')===-1)res.push(m);if(res.length>=120)break}}
res.sort((a,b)=>(b.importance||0)-(a.importance||0));return res.slice(0,120)}
function panel(n){ui.panel.classList.remove('hidden');ui.pTitle.textContent=`${n.label||n.id}`;ui.pSub.textContent=`${n.path||n.group||n.id}   ·  ${n.tier||''}  ·  deg=${deg.get(n.id)||0}`;bc(n);const kids=neigh(n);ui.pKids.innerHTML='';if(!kids.length){const e=document.createElement('div');e.className='panel-item';e.textContent='(no children / neighbors)';ui.pKids.appendChild(e)}else for(const m of kids)ui.pKids.appendChild(item(m,(m.path||m.group||'').replace(/\s+/g,' ').trim()));try{const meta=n.meta??{};const slim={};const keys=Object.keys(meta).slice(0,60);for(const k of keys){const v=meta[k];slim[k]=(typeof v==='string'&&v.length>280)?(v.slice(0,280)+'…'):v}ui.pMeta.textContent=JSON.stringify({id:n.id,label:n.label,path:n.path,group:n.group,tier:n.tier,importance:n.importance,degree:deg.get(n.id)||0,meta:slim},null,2)}catch{ui.pMeta.textContent=''}}
function parentId(n){const ins=inn.get(n.id);if(ins&&ins.size)for(const pid of ins)if(String(pid).startsWith('dir:'))return pid;const p=normPath(n.path);if(!p)return'';const d=isDir(p)?dirOf(p.slice(0,-1)):dirOf(p);if(!d)return'';return `dir:${d}`}
function up(){const n=by.get(String(sel));if(!n)return;const pid=parentId(n);if(!pid){T('No parent');return}const p=by.get(pid);if(p)focus(p.id,{push:true,anim:true});else T('Parent missing')}
function label(text,x0,y0,a){x.save();x.globalAlpha=a;x.font=`${Math.max(12,12/(v.k/d))}px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei`;x.textBaseline='middle';x.textAlign='left';x.fillStyle='rgba(240,250,255,.92)';x.shadowColor='rgba(0,0,0,.45)';x.shadowBlur=8;x.fillText(text,x0,y0);x.restore()}
function draw(){x.setTransform(1,0,0,1,0,0);x.fillStyle='#0b0f14';x.fillRect(0,0,c.width,c.height);x.save();x.translate(v.x,v.y);x.scale(v.k,v.k);
 x.save();x.lineWidth=1/v.k;x.strokeStyle='rgba(200,240,255,.06)';for(const r of [140,280,420]){x.beginPath();x.arc(0,0,r,0,Math.PI*2);x.stroke()}for(let i=0;i<24;i++){const a=i/24*Math.PI*2;const xx=Math.cos(a)*440,yy=Math.sin(a)*440;x.beginPath();x.moveTo(0,0);x.lineTo(xx,yy);x.stroke()}x.restore();
 const hi=new Set();if(hover)for(const t of (adj.get(hover)||[])){hi.add(hover+'|'+t);hi.add(t+'|'+hover)}if(sel)for(const t of (adj.get(sel)||[])){hi.add(sel+'|'+t);hi.add(t+'|'+sel)}
 x.lineCap='round';for(const e of links){const a=by.get(e.source),b=by.get(e.target);if(!a||!b)continue;const k=a.id+'|'+b.id;const h=hi.has(k);x.beginPath();x.moveTo(a.x,a.y);x.lineTo(b.x,b.y);x.strokeStyle=h?'rgba(112,255,210,.58)':'rgba(190,255,235,.16)';x.lineWidth=(h?1.8:1)/v.k;x.stroke()}
 for(const n of nodes){const isSel=n.id===sel,isH=n.id===hover,imp=n.tier==='P0'||n.tier==='P1';const rr=(n.r+(isH?2.3:0)+(isSel?1.8:0))/v.k;x.beginPath();x.arc(n.x,n.y,rr,0,Math.PI*2);x.fillStyle=imp?'rgba(112,255,210,.95)':'rgba(150,200,255,.78)';x.shadowColor=imp?'rgba(112,255,210,.35)':'rgba(150,200,255,.22)';x.shadowBlur=(isH||isSel||imp)?14/v.k:6/v.k;x.fill();x.shadowBlur=0;x.lineWidth=(isSel?2.4:1)/v.k;x.strokeStyle=isSel?'rgba(240,250,255,.9)':'rgba(255,255,255,.18)';x.stroke()}
 const z=v.k/d;const bud=z>1.2?220:(z>0.9?120:70);const sorted=[...nodes].sort((a,b)=>(b.importance||0)-(a.importance||0));let used=0;for(const n of sorted){const show=n.id===sel||n.id===hover||n.tier==='P0'||n.tier==='P1'||(used<bud&&z>0.75);if(!show)continue;const l=n.label||n.id;label(l,n.x+(n.r+10)/v.k,n.y,n.id===sel||n.id===hover?1:(n.tier==='P0'||n.tier==='P1'?0.9:0.65));if(n.tier!=='P0'&&n.tier!=='P1')used++;if(used>=bud)break}
 x.restore()}
function tick(){forces();draw();requestAnimationFrame(tick)}requestAnimationFrame(tick);
function results(list){ui.results.innerHTML='';if(!list.length){ui.results.classList.add('hidden');return}ui.results.classList.remove('hidden');for(const n of list){const el=document.createElement('div');el.className='result-item';const t=document.createElement('div');t.className='result-title';t.textContent=n.label||n.id;const s=document.createElement('div');s.className='result-sub';s.textContent=n.path||n.group||n.id;el.appendChild(t);el.appendChild(s);el.addEventListener('click',()=>{ui.results.classList.add('hidden');ui.search.value='';focus(n.id,{push:true,anim:true})});ui.results.appendChild(el)}}
ui.search.addEventListener('input',()=>{const q=ui.search.value.trim().toLowerCase();if(!q){results([]);return}const hits=[];for(const n of nodes){const hay=(String(n.label)+' '+String(n.path)+' '+String(n.id)).toLowerCase();if(hay.includes(q))hits.push(n);if(hits.length>=120)break}results(hits)});document.addEventListener('pointerdown',(e)=>{if(e.target===ui.search||ui.results.contains(e.target))return;ui.results.classList.add('hidden')});
c.addEventListener('pointerdown',(e)=>{c.setPointerCapture(e.pointerId);moved=false;last={x:e.clientX,y:e.clientY};const n=pick(e.clientX,e.clientY);if(n){dragN=n;dragS=SW(e.clientX,e.clientY);n.fx=n.x;n.fy=n.y}else{dragC=true;viewS={x:v.x,y:v.y};dragS={x:e.clientX,y:e.clientY}}});
c.addEventListener('pointermove',(e)=>{const dx=e.clientX-last.x,dy=e.clientY-last.y;if(Math.abs(dx)+Math.abs(dy)>2)moved=true;last={x:e.clientX,y:e.clientY};if(dragN){const p=SW(e.clientX,e.clientY);dragN.fx=p.x;dragN.fy=p.y;E=1;return}if(dragC){v.x=viewS.x+(e.clientX-dragS.x)*d;v.y=viewS.y+(e.clientY-dragS.y)*d;return}const n=pick(e.clientX,e.clientY);hover=n?n.id:null});
c.addEventListener('pointerup',(e)=>{dragC=false;if(dragN){if(!e.shiftKey){dragN.fx=null;dragN.fy=null}}dragN=null;if(moved)return;const n=pick(e.clientX,e.clientY);if(!n)return;const now=Date.now();const dbl=lastD.id===n.id&&(now-lastD.t)<320;lastD={id:n.id,t:now};focus(n.id,{push:true,anim:true});if(dbl||e.ctrlKey)openNode(n.id)});
c.addEventListener('wheel',(e)=>{e.preventDefault();const p=SW(e.clientX,e.clientY);const f=Math.exp(-e.deltaY*.0018);const k0=v.k;const k1=Math.max(.18*d,Math.min(5*d,k0*f));v.k=k1;v.x=v.x+(p.x*k0-p.x*k1);v.y=v.y+(p.y*k0-p.y*k1)},{passive:false});
ui.btnFit.addEventListener('click',()=>{fit();T('Fit')});ui.btnPause.addEventListener('click',()=>{run=!run;ui.btnPause.textContent=run?'Pause':'Resume';T(run?'Running':'Paused')});ui.btnReheat.addEventListener('click',()=>{E=1;T('Reheat')});ui.btnOpen.addEventListener('click',()=>{if(sel)openNode(sel)});ui.btnPin.addEventListener('click',()=>{const n=by.get(String(sel));if(!n)return;if(n.fx==null&&n.fy==null){n.fx=n.x;n.fy=n.y;T('Pinned')}else{n.fx=null;n.fy=null;T('Unpinned')}});ui.btnClose.addEventListener('click',()=>ui.panel.classList.add('hidden'));ui.btnBack.addEventListener('click',back);ui.btnForward.addEventListener('click',forward);ui.btnUp.addEventListener('click',up);navBtns();
window.addEventListener('keydown',(e)=>{const a=document.activeElement;if(a&&(a.tagName==='INPUT'||a.tagName==='TEXTAREA'))return;if(e.key===' '){e.preventDefault();ui.btnPause.click();return}if(e.key==='Escape'){ui.panel.classList.add('hidden');return}if(e.key==='Enter'){if(sel)openNode(sel);return}if(e.key==='Home'){fit();return}if(e.key==='Backspace'){back();return}if(e.altKey&&e.key==='ArrowLeft'){back();return}if(e.altKey&&e.key==='ArrowRight'){forward();return}if(e.key==='r'||e.key==='R'){E=1;return}if(e.key==='u'||e.key==='U'){up();return}});
let bridge=null;function openNode(id){const n=by.get(String(id));if(!n)return;const path=n.path;try{if(bridge&&typeof bridge.openNodeNewWindow==='function'){bridge.openNodeNewWindow(String(id));return}if(bridge&&typeof bridge.openPathNewWindow==='function'&&path){bridge.openPathNewWindow(String(path));return}if(bridge&&typeof bridge.openNode==='function'){bridge.openNode(String(id));return}if(bridge&&typeof bridge.openPath==='function'&&path){bridge.openPath(String(path));return}}catch(err){console.warn('[SDDAI] openNode error',err)}T('No bridge: open disabled');console.log('[SDDAI] openNode',id,n)}
function tryBridge(){if(!window.qt||!window.qt.webChannelTransport)return false;try{new QWebChannel(window.qt.webChannelTransport,(ch)=>{bridge=ch.objects.bridge||ch.objects.GraphBridge||ch.objects.sddai||ch.objects.app||null;if(!bridge){T('QWebChannel ok, but no bridge object');return}if(typeof bridge.getGraphJson==='function'){try{bridge.getGraphJson((js)=>{if(!js)return;try{setGraph(JSON.parse(js))}catch(e){console.error(e)}})}catch{try{const js=bridge.getGraphJson();if(js)setGraph(JSON.parse(js))}catch{}}}
for(const s of ['graphJson','graphJsonChanged','graphReady','graphUpdated'])if(bridge[s]&&typeof bridge[s].connect==='function')bridge[s].connect((js)=>{try{setGraph(JSON.parse(js))}catch(e){console.error(e)}});
if(typeof bridge.requestGraph==='function')try{bridge.requestGraph()}catch{}
T('Bridge connected')});return true}catch(e){console.warn('[SDDAI] QWebChannel init failed',e);return false}}
async function demo(){try{const r=await fetch('./demo_graph.json',{cache:'no-store'});const g=await r.json();setGraph(g)}catch(e){console.warn('[SDDAI] demo_graph.json failed, using bootstrap',e);setGraph({nodes:[{id:'README',label:'README.md',path:'README.md',tier:'P0'},{id:'specs',label:'specs/',path:'specs/',tier:'P1'},{id:'tasks',label:'tasks.md',path:'tasks.md',tier:'P1'},{id:'runbook',label:'runbook.md',path:'runbook.md',tier:'P2'}],links:[{source:'README',target:'specs'},{source:'README',target:'tasks'},{source:'specs',target:'runbook'}]})}}
window.SDDAI_GRAPH={setData:(g)=>setGraph(g),setJson:(j)=>setGraph(JSON.parse(j)),focus:(id)=>focus(id,{push:true,anim:true}),fit:()=>fit(),back:()=>back(),forward:()=>forward(),up:()=>up()};
if(!tryBridge())demo();})();
